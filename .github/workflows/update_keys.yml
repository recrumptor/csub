name: Update VLESS Keys

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  
permissions:
  contents: write
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process Keys
        run: |
          python3 -c "
          import urllib.parse as urlparse
          import requests
          import re

          unique_configs = {}
          
          with open('site.txt', 'r') as f:
              urls = [line.strip() for line in f if line.strip()]

          for url in urls:
              try:
                  response = requests.get(url, timeout=15)
                  for line in response.text.splitlines():
                      line = line.strip()
                      if not line or '://' not in line:
                          continue
                      
                      # 1. Полностью отсекаем имя (всё после #)
                      full_link = line.split('#')[0].strip()
                      
                      # 2. Разбираем ссылку вручную, так как urlparse может капризничать с протоколами vless/vmess
                      if '?' in full_link:
                          base_address, params_str = full_link.split('?', 1)
                          # Сортируем параметры (sni, security, и т.д.)
                          params = params_str.split('&')
                          params.sort()
                          normalized_link = base_address + '?' + '&'.join(params)
                      else:
                          normalized_link = full_link

                      # 3. Сравниваем по 'чистой' ссылке без имени
                      if normalized_link not in unique_configs:
                          unique_configs[normalized_link] = line
              except Exception as e:
                  print(f'Error: {e}')

          with open('vless_list.txt', 'w', encoding='utf-8') as f:
              for original_line in unique_configs.values():
                  f.write(original_line + '\n')
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add vless_list.txt
          git commit -m "Update unique keys" || exit 0
          git push
