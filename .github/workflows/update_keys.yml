name: Update VLESS Keys

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process Keys
        run: |
          python3 - << 'EOF'
          import urllib.parse as urlparse
          import requests

          unique_configs = {}
          
          # Читаем ссылки из site.txt
          try:
              with open('site.txt', 'r') as f:
                  urls = [line.strip() for line in f if line.strip()]
          except FileNotFoundError:
              print("site.txt не найден")
              exit(1)

          def normalize_link(line):
              # 1. Отсекаем имя (#)
              base = line.split('#')[0].strip()
              if '?' not in base:
                  return base.lower().strip()

              # 2. Разделяем адрес и параметры
              base_part, params_str = base.split('?', 1)
              base_part = base_part.lower().strip()

              # 3. Разбираем и нормализуем параметры
              params = {}
              for p in params_str.split('&'):
                  if '=' in p:
                      k, v = p.split('=', 1)
                      k = k.lower().strip()
                      # Декодируем спецсимволы и убираем пробелы
                      v = urlparse.unquote(v).strip()
                      params[k] = v
                  elif p:
                      params[p.lower().strip()] = ""

              # 4. Собираем обратно с сортировкой ключей
              normalized_params = "&".join(f"{k}={params[k]}" for k in sorted(params))
              return f"{base_part}?{normalized_params}"

          for url in urls:
              try:
                  print(f"Загрузка: {url}")
                  response = requests.get(url, timeout=15)
                  for line in response.text.splitlines():
                      line = line.strip()
                      if not line or '://' not in line:
                          continue

                      # Создаем уникальный отпечаток ссылки
                      norm = normalize_link(line)

                      if norm not in unique_configs:
                          unique_configs[norm] = line
              except Exception as e:
                  print(f"Ошибка при работе с {url}: {e}")

          # Сохраняем результат
          with open('vless_list.txt', 'w', encoding='utf-8') as f:
              for original in unique_configs.values():
                  f.write(original + '\n')
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add vless_list.txt
          git commit -m "Update unique keys" || exit 0
          git push
