name: Update VLESS Keys

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process Keys
        run: |
          python3 -c "
          import urllib.parse as urlparse
          import requests

          unique_configs = {}
          
          # Читаем список сайтов
          with open('site.txt', 'r') as f:
              urls = [line.strip() for line in f if line.strip()]

          for url in urls:
              try:
                  response = requests.get(url, timeout=10)
                  for line in response.text.splitlines():
                      line = line.strip()
                      if not line or '://' not in line:
                          continue
                      
                      # 1. Отделяем часть с параметрами от комментария
                      # Пример: vless://id@host:port?params#name
                      part_without_comment = line.split('#')[0]
                      
                      # 2. Разбираем URL
                      parsed = urlparse.urlparse(part_without_comment)
                      base_address = f'{parsed.scheme}://{parsed.netloc}{parsed.path}'
                      
                      # 3. Нормализуем параметры (сортируем их по алфавиту)
                      params = urlparse.parse_qsl(parsed.query)
                      params.sort() # Сортировка делает порядок параметров неважным
                      normalized_params = urlparse.urlencode(params)
                      
                      # Создаем уникальный ключ для сравнения
                      comparison_key = f'{base_address}?{normalized_params}'
                      
                      # Если такого ключа еще нет, сохраняем оригинальную строку
                      if comparison_key not in unique_configs:
                          unique_configs[comparison_key] = line
              except Exception as e:
                  print(f'Error downloading {url}: {e}')

          # Записываем результат
          with open('vless_list.txt', 'w', encoding='utf-8') as f:
              for key_original in unique_configs.values():
                  f.write(key_original + '\n')
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add vless_list.txt
          git commit -m "Update unique keys" || exit 0
          git push
