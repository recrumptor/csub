name: Update VLESS Keys

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  
permissions:
  contents: write
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

            - name: Process Keys
        run: |
          python3 - << 'EOF'
import urllib.parse as urlparse
import requests

unique = {}

with open('site.txt', 'r') as f:
    urls = [line.strip() for line in f if line.strip()]

def normalize_link(line):
    # Убираем имя
    base = line.split('#')[0].strip()

    # Если нет параметров
    if '?' not in base:
        return base.lower()

    base_part, params_str = base.split('?', 1)

    # Приводим base к нижнему регистру (uuid, host)
    base_part = base_part.lower().strip()

    # Разбор параметров
    params = {}
    for p in params_str.split('&'):
        if '=' in p:
            k, v = p.split('=', 1)
            k = k.lower().strip()
            v = urlparse.unquote(v).strip()
            params[k] = v
        else:
            params[p.lower().strip()] = ""

    # Сортировка параметров по ключу
    normalized_params = "&".join(f"{k}={params[k]}" for k in sorted(params))

    return base_part + "?" + normalized_params


for url in urls:
    try:
        response = requests.get(url, timeout=15)
        for line in response.text.splitlines():
            line = line.strip()
            if not line or '://' not in line:
                continue

            normalized = normalize_link(line)

            # Если такой нормализованный вариант ещё не встречался
            if normalized not in unique:
                unique[normalized] = line  # сохраняем оригинал с именем

    except Exception as e:
        print("Error:", e)

with open('vless_list.txt', 'w', encoding='utf-8') as f:
    for original in unique.values():
        f.write(original + '\n')

EOF


      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add vless_list.txt
          git commit -m "Update unique keys" || exit 0
          git push
